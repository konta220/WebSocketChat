<head>
    <meta charset="utf-8">
    <title>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ£ãƒƒãƒˆ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
    <style>
        .postInfo {
            font-size: 0.8rem;
            color: #888888;
            margin-top: 0.5rem;
        }

        .postMessage {
            font-size: 1rem;
            color: #000000;
        }

        .postMsgBox {
            width: 80%;
            line-height: 1rem;
            margin-top: 0.2rem;
            border: solid 1px #dcdcdc;
            font-size: inherit;
            border-radius: 32px;
            padding: 16px;
        }

        #send {
            border-radius: 32px;
            border: none;
            padding: 16px;
        }

        #chat {
            width: 100%;
            border: solid 1px #FFFFFF;
            overflow: auto;
        }

        #id {
            width: 100%;
            border: solid 1px #FFFFFF;
        }

        #viewUserId {
            margin-top: 0.5rem;
        }
    </style>
    <div id="id"></div>
    <input id="msg" type="text" class="postMsgBox" value="" onkeypress="sendEnter(event);" placeholder="ğŸ–Šï¸æŠ•ç¨¿ã—ãŸã„å†…å®¹ã‚’å…¥åŠ›"
        maxlength="128" />
    <button id="send" type="button" onclick="sendChat()">âœ¨æŠ•ç¨¿</button>
    <div id="chat"></div>
    <script>
        const chatRoomName = "websocketChatRoom";
        const dummyPassword = "1234Password";

        var chat = document.getElementById("chat");
        // IDç”Ÿæˆ
        var id = Math.random().toString(32).substring(2);
        document.getElementById("id").innerHTML = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ID : ' + escapeHtml(id);
        // WSæ¥ç¶šï¼ˆAchexã¸æ¥ç¶šï¼‰
        ws = new WebSocket("wss://cloud.achex.ca/websocketChat");
        // WSæ¥ç¶š
        ws.onopen = e => {
            console.log('open');
            chat.innerHTML = '<div id="viewUserId">ã‚ãªãŸã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID : ' + escapeHtml(id) + 'ï¼ˆ' + getDateTime() + 'ï¼‰</div>';
            // èªè¨¼ï¼ˆauth, passwordã¯ä½•ã§ã‚‚OKï¼‰
            ws.send(JSON.stringify({ "auth": chatRoomName, "password": dummyPassword }));
            // 
            ws.send(JSON.stringify({ "to": chatRoomName, "id": id, "message": 'å…¥å®¤ã—ã¾ã—ãŸã€‚' }));
        }
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡
        ws.onmessage = e => {
            console.log('message');
            console.log(e);
            var obj = JSON.parse(e.data);
            if (obj.auth == 'OK') {
                // èªè¨¼OK
                return;
            }
            addChat(obj.id, obj.message);
        }
        // WSåˆ‡æ–­
        ws.onclosed = e => {
            console.log('closed');
            ws.send(JSON.stringify({ "to": chatRoomName, "id": id, "message": 'é€€å®¤ã—ã¾ã—ãŸã€‚' }));
        }

        function escapeHtml(string) {
            if (typeof string !== 'string') {
                return string;
            }
            return string.replace(/[&'`"<>]/g, function (match) {
                return {
                    '&': '&amp;',
                    "'": '&#x27;',
                    '`': '&#x60;',
                    '"': '&quot;',
                    '<': '&lt;',
                    '>': '&gt;',
                }[match]
            });
        }

        function sendEnter(event) {
            const msgElem = document.getElementById("msg");
            const msg = msgElem.value;

            //ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼æŠ¼ä¸‹ãªã‚‰
            if (event === undefined || event.keyCode === 13) {

                //ã‚³ãƒ¡ãƒ³ãƒˆãŒç©ºãªã‚‰ä½•ã‚‚ã—ãªã„
                if (msg === "") {
                    alert("æŠ•ç¨¿ã—ãŸã„æ–‡å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                    return;
                }

                sendChat();
            }
        }
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
        function sendChat() {
            let msgElem = document.getElementById("msg");
            let msg = msgElem.value;
            msgElem.value = "";

            //ã‚³ãƒ¡ãƒ³ãƒˆãŒç©ºãªã‚‰ä½•ã‚‚ã—ãªã„
            if (msg === "") {
                alert("æŠ•ç¨¿ã—ãŸã„æ–‡å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }

            ws.send(JSON.stringify({ "to": chatRoomName, "id": id, "message": msg }));
        }
        // ãƒãƒ£ãƒƒãƒˆ
        function addChat(id, msg) {
            chat.innerHTML = '<div class="msgBox"><div class="postInfo">' + escapeHtml(id) + 'ã•ã‚“ : ' + 'ï¼ˆ' + getDateTime() + 'ï¼‰' + '</div>'
                + '<div class="postMessage">' + escapeHtml(msg.substr(0, 128)) + '</div></div>'
                + chat.innerHTML;
        }
        // 1æ¡ã®æ•°å­—ã‚’0åŸ‹ã‚ã§2æ¡ã«ã™ã‚‹
        var toDoubleDigits = function (num) {
            num += "";
            if (num.length === 1) {
                num = "0" + num;
            }
            return num;
        };
        // æ—¥æ™‚å–å¾— YYYY/MM/DD HH:DD:MI:SSå½¢å¼ã§å–å¾—
        var getDateTime = function () {
            var date = new Date();
            var year = date.getFullYear();
            var month = toDoubleDigits(date.getMonth() + 1);
            var day = toDoubleDigits(date.getDate());
            var hour = toDoubleDigits(date.getHours());
            var min = toDoubleDigits(date.getMinutes());
            var sec = toDoubleDigits(date.getSeconds());
            return year + '/' + month + '/' + day + ' ' + hour + ':' + min + ':' + sec;
        };

        // å‚è€ƒã‚µã‚¤ãƒˆ
        // https://c-a-p-engineer.github.io/tech/2021/09/03/websocket-achex/
    </script>
</body>